name: Release

on:
  push:
    tags:
      - 'v*'

env:
  GO_VERSION: '1.24'

permissions:
  contents: write

jobs:
  build-cli-binaries:
    name: Build CLI - ${{ matrix.goos }}-${{ matrix.goarch }}
    runs-on: ${{ matrix.runner }}
    strategy:
      matrix:
        include:
          - goos: darwin
            goarch: amd64
            runner: macos-latest
          - goos: darwin
            goarch: arm64
            runner: macos-latest
          - goos: linux
            goarch: amd64
            runner: self-hosted
          - goos: linux
            goarch: arm64
            runner: self-hosted
          - goos: windows
            goarch: amd64
            runner: self-hosted
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: ${{ env.GO_VERSION }}
    
    - name: Get version from tag
      id: get_version
      run: echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
    
    - name: Build binary
      env:
        GOOS: ${{ matrix.goos }}
        GOARCH: ${{ matrix.goarch }}
        VERSION: ${{ steps.get_version.outputs.version }}
      run: |
        BINARY_NAME="pca-${GOOS}-${GOARCH}"
        if [ "$GOOS" = "windows" ]; then
          BINARY_NAME="${BINARY_NAME}.exe"
        fi
        
        # Build with version information
        mkdir -p build
        go build -ldflags="-s -w \
          -X github.com/bitjungle/gopca/internal/version.Version=${VERSION} \
          -X github.com/bitjungle/gopca/internal/version.GitCommit=$(git rev-parse --short HEAD) \
          -X github.com/bitjungle/gopca/internal/version.BuildDate=$(date -u +\"%Y-%m-%dT%H:%M:%SZ\")" \
          -o "build/${BINARY_NAME}" \
          cmd/gopca-cli/main.go
        
        echo "BINARY_NAME=${BINARY_NAME}" >> $GITHUB_ENV
    
    - name: Sign CLI binary (macOS)
      if: matrix.goos == 'darwin'
      env:
        APPLE_CERTIFICATE_BASE64: ${{ secrets.APPLE_CERTIFICATE_BASE64 }}
        APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
        APPLE_IDENTITY: ${{ secrets.APPLE_IDENTITY }}
      run: |
        ./scripts/ci/sign-macos-ci.sh "build/${{ env.BINARY_NAME }}"
    
    - name: Notarize CLI binary (macOS)
      if: matrix.goos == 'darwin'
      env:
        APPLE_ID: ${{ secrets.APPLE_ID }}
        APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
        APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
      run: |
        ./scripts/ci/notarize-macos-ci.sh "build/${{ env.BINARY_NAME }}"
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: pca-${{ matrix.goos }}-${{ matrix.goarch }}
        path: build/${{ env.BINARY_NAME }}
        retention-days: 1

  build-desktop:
    name: Build Desktop - ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux
          - os: macos-latest
            platform: darwin
          - os: windows-latest
            platform: windows
    runs-on: ${{ matrix.os }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: ${{ env.GO_VERSION }}
    
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: package-lock.json
    
    - name: Install Wails
      run: go install github.com/wailsapp/wails/v2/cmd/wails@latest
    
    - name: Install Linux dependencies
      if: matrix.os == 'ubuntu-latest'
      run: ./scripts/ci/install-linux-deps.sh
    
    - name: Install all dependencies (monorepo)
      run: |
        npm ci
    
    - name: Build shared UI components
      run: |
        npm run build-ui
    
    - name: Get version from tag
      id: get_version
      run: echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
    
    - name: Build desktop app
      working-directory: cmd/gopca-desktop
      env:
        VERSION: ${{ steps.get_version.outputs.version }}
      shell: bash
      run: |
        export PATH=$PATH:$(go env GOPATH)/bin
        wails build -platform ${{ matrix.platform }} -ldflags "-s -w \
          -X github.com/bitjungle/gopca/internal/version.Version=${VERSION} \
          -X github.com/bitjungle/gopca/internal/version.GitCommit=$(git rev-parse --short HEAD) \
          -X github.com/bitjungle/gopca/internal/version.BuildDate=$(date -u +\"%Y-%m-%dT%H:%M:%SZ\")"
    
    - name: Sign Desktop app (macOS)
      if: matrix.os == 'macos-latest'
      env:
        APPLE_CERTIFICATE_BASE64: ${{ secrets.APPLE_CERTIFICATE_BASE64 }}
        APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
        APPLE_IDENTITY: ${{ secrets.APPLE_IDENTITY }}
      run: |
        ./scripts/ci/sign-macos-ci.sh cmd/gopca-desktop/build/bin/GoPCA.app
    
    - name: Notarize Desktop app (macOS)
      if: matrix.os == 'macos-latest'
      env:
        APPLE_ID: ${{ secrets.APPLE_ID }}
        APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
        APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
      run: |
        ./scripts/ci/notarize-macos-ci.sh cmd/gopca-desktop/build/bin/GoPCA.app
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: gopca-desktop-${{ matrix.os }}
        path: |
          cmd/gopca-desktop/build/bin/GoPCA.app
          cmd/gopca-desktop/build/bin/GoPCA.exe
          cmd/gopca-desktop/build/bin/GoPCA
        retention-days: 1

  build-gocsv:
    name: Build GoCSV - ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux
          - os: macos-latest
            platform: darwin
          - os: windows-latest
            platform: windows
    runs-on: ${{ matrix.os }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: ${{ env.GO_VERSION }}
    
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: package-lock.json
    
    - name: Install Wails
      run: go install github.com/wailsapp/wails/v2/cmd/wails@latest
    
    - name: Install Linux dependencies
      if: matrix.os == 'ubuntu-latest'
      run: ./scripts/ci/install-linux-deps.sh
    
    - name: Install all dependencies (monorepo)
      run: |
        npm ci
    
    - name: Build shared UI components
      run: |
        npm run build-ui
    
    - name: Get version from tag
      id: get_version
      run: echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
    
    - name: Build GoCSV app
      working-directory: cmd/gocsv
      env:
        VERSION: ${{ steps.get_version.outputs.version }}
      shell: bash
      run: |
        export PATH=$PATH:$(go env GOPATH)/bin
        wails build -platform ${{ matrix.platform }} -ldflags "-s -w \
          -X github.com/bitjungle/gopca/internal/version.Version=${VERSION} \
          -X github.com/bitjungle/gopca/internal/version.GitCommit=$(git rev-parse --short HEAD) \
          -X github.com/bitjungle/gopca/internal/version.BuildDate=$(date -u +\"%Y-%m-%dT%H:%M:%SZ\")"
    
    - name: Sign GoCSV app (macOS)
      if: matrix.os == 'macos-latest'
      env:
        APPLE_CERTIFICATE_BASE64: ${{ secrets.APPLE_CERTIFICATE_BASE64 }}
        APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
        APPLE_IDENTITY: ${{ secrets.APPLE_IDENTITY }}
      run: |
        ./scripts/ci/sign-macos-ci.sh cmd/gocsv/build/bin/GoCSV.app
    
    - name: Notarize GoCSV app (macOS)
      if: matrix.os == 'macos-latest'
      env:
        APPLE_ID: ${{ secrets.APPLE_ID }}
        APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
        APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
      run: |
        ./scripts/ci/notarize-macos-ci.sh cmd/gocsv/build/bin/GoCSV.app
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: gocsv-${{ matrix.os }}
        path: |
          cmd/gocsv/build/bin/GoCSV.app
          cmd/gocsv/build/bin/GoCSV.exe
          cmd/gocsv/build/bin/GoCSV
        retention-days: 1

  sign-windows-binaries:
    name: Sign Windows Binaries
    runs-on: ubuntu-latest
    needs: [build-cli-binaries, build-desktop, build-gocsv]
    # Only run if SignPath secrets are configured
    if: |
      github.event_name == 'push' && 
      contains(github.ref, 'refs/tags/')
    
    steps:
    - name: Check SignPath Configuration
      id: check_signpath
      run: |
        if [ -n "${{ secrets.SIGNPATH_API_TOKEN }}" ] && [ -n "${{ secrets.SIGNPATH_ORG_ID }}" ]; then
          echo "configured=true" >> $GITHUB_OUTPUT
          echo "SignPath is configured, will sign Windows binaries"
        else
          echo "configured=false" >> $GITHUB_OUTPUT
          echo "SignPath not configured, skipping Windows signing"
        fi
    
    - name: Download Windows CLI artifact
      if: steps.check_signpath.outputs.configured == 'true'
      uses: actions/download-artifact@v4
      with:
        name: pca-windows-amd64
        path: windows-cli
    
    - name: Download Windows Desktop artifact
      if: steps.check_signpath.outputs.configured == 'true'
      uses: actions/download-artifact@v4
      with:
        name: gopca-desktop-windows-latest
        path: windows-desktop
    
    - name: Download Windows GoCSV artifact
      if: steps.check_signpath.outputs.configured == 'true'
      uses: actions/download-artifact@v4
      with:
        name: gocsv-windows-latest
        path: windows-gocsv
    
    # Sign CLI binary
    - name: Upload CLI for signing
      if: steps.check_signpath.outputs.configured == 'true'
      id: upload-cli
      uses: actions/upload-artifact@v4
      with:
        name: unsigned-cli
        path: windows-cli/pca-windows-amd64.exe
    
    - name: Sign CLI binary
      if: steps.check_signpath.outputs.configured == 'true'
      id: sign-cli
      uses: SignPath/github-action-submit-signing-request@v1
      with:
        api-token: ${{ secrets.SIGNPATH_API_TOKEN }}
        organization-id: ${{ secrets.SIGNPATH_ORG_ID }}
        project-slug: gopca
        signing-policy-slug: test-signing
        github-artifact-id: ${{ steps.upload-cli.outputs.artifact-id }}
        wait-for-completion: true
        output-artifact-directory: signed-cli
    
    # Sign Desktop app
    - name: Upload Desktop for signing
      if: steps.check_signpath.outputs.configured == 'true'
      id: upload-desktop
      uses: actions/upload-artifact@v4
      with:
        name: unsigned-desktop
        path: windows-desktop/GoPCA.exe
    
    - name: Sign Desktop app
      if: steps.check_signpath.outputs.configured == 'true'
      id: sign-desktop
      uses: SignPath/github-action-submit-signing-request@v1
      with:
        api-token: ${{ secrets.SIGNPATH_API_TOKEN }}
        organization-id: ${{ secrets.SIGNPATH_ORG_ID }}
        project-slug: gopca
        signing-policy-slug: test-signing
        github-artifact-id: ${{ steps.upload-desktop.outputs.artifact-id }}
        wait-for-completion: true
        output-artifact-directory: signed-desktop
    
    # Sign GoCSV app
    - name: Upload GoCSV for signing
      if: steps.check_signpath.outputs.configured == 'true'
      id: upload-gocsv
      uses: actions/upload-artifact@v4
      with:
        name: unsigned-gocsv
        path: windows-gocsv/GoCSV.exe
    
    - name: Sign GoCSV app
      if: steps.check_signpath.outputs.configured == 'true'
      id: sign-gocsv
      uses: SignPath/github-action-submit-signing-request@v1
      with:
        api-token: ${{ secrets.SIGNPATH_API_TOKEN }}
        organization-id: ${{ secrets.SIGNPATH_ORG_ID }}
        project-slug: gopca
        signing-policy-slug: test-signing
        github-artifact-id: ${{ steps.upload-gocsv.outputs.artifact-id }}
        wait-for-completion: true
        output-artifact-directory: signed-gocsv
    
    # Upload signed artifacts
    - name: Upload signed Windows artifacts
      if: steps.check_signpath.outputs.configured == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: windows-signed
        path: |
          signed-cli/pca-windows-amd64.exe
          signed-desktop/GoPCA.exe
          signed-gocsv/GoCSV.exe
        retention-days: 1
    
    - name: Create signing status artifact
      if: always()
      run: |
        if [ "${{ steps.check_signpath.outputs.configured }}" = "true" ] && \
           [ "${{ steps.sign-cli.outcome }}" = "success" ] && \
           [ "${{ steps.sign-desktop.outcome }}" = "success" ] && \
           [ "${{ steps.sign-gocsv.outcome }}" = "success" ]; then
          echo "signed" > signing-status.txt
        else
          echo "unsigned" > signing-status.txt
        fi
    
    - name: Upload signing status
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: signing-status
        path: signing-status.txt
        retention-days: 1

  create-release:
    name: Create Release with Artifacts
    runs-on: ubuntu-latest
    needs: [build-cli-binaries, build-desktop, build-gocsv, sign-windows-binaries]
    if: always() && !cancelled()
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts
    
    - name: Check signing status
      id: check_signed
      run: |
        if [ -f "artifacts/signing-status/signing-status.txt" ]; then
          STATUS=$(cat artifacts/signing-status/signing-status.txt)
          echo "windows_signed=${STATUS}" >> $GITHUB_OUTPUT
          echo "Windows binaries are: ${STATUS}"
        else
          echo "windows_signed=unsigned" >> $GITHUB_OUTPUT
          echo "Windows binaries are: unsigned (SignPath not configured)"
        fi
    
    - name: Organize and package artifacts
      run: |
        cd artifacts
        
        # Create directories for platform bundles
        mkdir -p macos windows linux
        
        # === macOS Bundle (Intel and ARM) ===
        echo "Creating macOS bundle..."
        
        # CLI binaries - both architectures
        if [ -f "pca-darwin-amd64/pca-darwin-amd64" ]; then
          cp "pca-darwin-amd64/pca-darwin-amd64" "macos/pca-intel"
        fi
        if [ -f "pca-darwin-arm64/pca-darwin-arm64" ]; then
          cp "pca-darwin-arm64/pca-darwin-arm64" "macos/pca-arm64"
        fi
        
        # Desktop app
        if [ -d "gopca-desktop-macos-latest/GoPCA.app" ]; then
          cp -r "gopca-desktop-macos-latest/GoPCA.app" "macos/"
        fi
        
        # GoCSV app
        if [ -d "gocsv-macos-latest/GoCSV.app" ]; then
          cp -r "gocsv-macos-latest/GoCSV.app" "macos/"
        fi
        
        # Create macOS bundle zip
        cd macos
        zip -r ../gopca-macos-universal.zip .
        cd ..
        
        # === Windows Bundle ===
        echo "Creating Windows bundle..."
        
        # CLI binary (prefer signed)
        if [ "${{ steps.check_signed.outputs.windows_signed }}" = "signed" ] && [ -f "windows-signed/pca-windows-amd64.exe" ]; then
          echo "Using signed Windows CLI binary"
          cp "windows-signed/pca-windows-amd64.exe" "windows/pca.exe"
        elif [ -f "pca-windows-amd64/pca-windows-amd64.exe" ]; then
          echo "Using unsigned Windows CLI binary"
          cp "pca-windows-amd64/pca-windows-amd64.exe" "windows/pca.exe"
        fi
        
        # Desktop app (prefer signed)
        if [ "${{ steps.check_signed.outputs.windows_signed }}" = "signed" ] && [ -f "windows-signed/GoPCA.exe" ]; then
          echo "Using signed Windows Desktop binary"
          cp "windows-signed/GoPCA.exe" "windows/GoPCA.exe"
        elif [ -f "gopca-desktop-windows-latest/GoPCA.exe" ]; then
          echo "Using unsigned Windows Desktop binary"
          cp "gopca-desktop-windows-latest/GoPCA.exe" "windows/GoPCA.exe"
        fi
        
        # GoCSV app (prefer signed)
        if [ "${{ steps.check_signed.outputs.windows_signed }}" = "signed" ] && [ -f "windows-signed/GoCSV.exe" ]; then
          echo "Using signed Windows GoCSV binary"
          cp "windows-signed/GoCSV.exe" "windows/GoCSV.exe"
        elif [ -f "gocsv-windows-latest/GoCSV.exe" ]; then
          echo "Using unsigned Windows GoCSV binary"
          cp "gocsv-windows-latest/GoCSV.exe" "windows/GoCSV.exe"
        fi
        
        # Create Windows bundle zip
        cd windows
        zip -r ../gopca-windows-x64.zip .
        cd ..
        
        # === Linux Bundle (x64 and ARM64) ===
        echo "Creating Linux bundle..."
        
        # CLI binaries - both architectures
        if [ -f "pca-linux-amd64/pca-linux-amd64" ]; then
          cp "pca-linux-amd64/pca-linux-amd64" "linux/pca-x64"
        fi
        if [ -f "pca-linux-arm64/pca-linux-arm64" ]; then
          cp "pca-linux-arm64/pca-linux-arm64" "linux/pca-arm64"
        fi
        
        # Desktop app
        if [ -f "gopca-desktop-ubuntu-latest/GoPCA" ]; then
          cp "gopca-desktop-ubuntu-latest/GoPCA" "linux/GoPCA"
        fi
        
        # GoCSV app
        if [ -f "gocsv-ubuntu-latest/GoCSV" ]; then
          cp "gocsv-ubuntu-latest/GoCSV" "linux/GoCSV"
        fi
        
        # Create Linux bundle tar.gz
        cd linux
        tar -czf ../gopca-linux-x64.tar.gz .
        cd ..
        
        # Clean up temporary directories
        rm -rf macos windows linux
        rm -rf pca-* gopca-desktop-* gocsv-* windows-signed signing-status unsigned-*
        
        # Generate checksums for the bundles
        shasum -a 256 gopca-*.zip gopca-*.tar.gz > checksums.txt
        
        # List final artifacts
        echo "=== Final release artifacts ==="
        ls -lh gopca-*.zip gopca-*.tar.gz checksums.txt
        echo "==============================="
    
    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        files: |
          artifacts/gopca-macos-universal.zip
          artifacts/gopca-windows-x64.zip
          artifacts/gopca-linux-x64.tar.gz
          artifacts/checksums.txt
        generate_release_notes: true
        fail_on_unmatched_files: false
        body: |
          ## Downloads
          
          Download the complete bundle for your platform. Each bundle contains:
          - **PCA CLI**: Command-line tool for scripting and automation
          - **GoPCA Desktop**: GUI application for interactive PCA analysis
          - **GoCSV**: Data preparation and CSV editing tool
          
          ### Platform Bundles
          
          | Platform | Download | Contents |
          |----------|----------|----------|
          | **macOS** | [`gopca-macos-universal.zip`](../../releases/download/${{ github.ref_name }}/gopca-macos-universal.zip) | • `pca-intel` and `pca-arm64` CLI tools<br>• `GoPCA.app` (signed & notarized)<br>• `GoCSV.app` (signed & notarized) |
          | **Windows** | [`gopca-windows-x64.zip`](../../releases/download/${{ github.ref_name }}/gopca-windows-x64.zip) | • `pca.exe` CLI tool${{ steps.check_signed.outputs.windows_signed == 'signed' && ' (digitally signed)' || '' }}<br>• `GoPCA.exe`${{ steps.check_signed.outputs.windows_signed == 'signed' && ' (digitally signed)' || '' }}<br>• `GoCSV.exe`${{ steps.check_signed.outputs.windows_signed == 'signed' && ' (digitally signed)' || '' }} |
          | **Linux** | [`gopca-linux-x64.tar.gz`](../../releases/download/${{ github.ref_name }}/gopca-linux-x64.tar.gz) | • `pca-x64` and `pca-arm64` CLI tools<br>• `GoPCA` desktop app<br>• `GoCSV` editor |
          
          ### Installation
          
          1. Download the bundle for your platform
          2. Extract the archive to your preferred location
          3. Add the directory to your PATH for CLI access (optional)
          4. On macOS: Right-click and select "Open" on first launch to bypass Gatekeeper
          
          ### Verification
          
          SHA-256 checksums: [`checksums.txt`](../../releases/download/${{ github.ref_name }}/checksums.txt)
          
          ${{ steps.check_signed.outputs.windows_signed == 'signed' && '✅ **Windows binaries are digitally signed** - No security warnings on Windows 10/11' || '⚠️ **Windows binaries are not digitally signed** - You may see security warnings when running' }}
          
          ---